#+TITLE: Deploying the Client Server application
#+AUTHOR: Shubh
#+DATE: [2017-06-05 Mon]
#+SETUPFILE: ../org-templates/level-1.org
#+TAGS: boilerplate(b)
#+EXCLUDE_TAGS: boilerplate
#+OPTIONS: ^:nil

* Introduction
  This document will illustrate working of small example of VLEAD microservice, client server for the Oauth.

* Implementation 
  The client server is a small server with login and logout routes.These routes redirect the client server to the oauth service.

#+BEGIN_SRC python :eval no :tangle client.py
from flask import Flask, redirect, url_for, session, request, jsonify, abort,render_template
import requests	
from flask_cas import CAS
from flask_cas import login_required


app = Flask(__name__)
cas = CAS(app, '/cas')
app.secret_key = "devel"
app.config['CAS_SERVER'] = 'https://localhost:8443/cas' 
app.config['CAS_AFTER_LOGIN'] = 'route_root'


@app.route('/')
@login_required
def route_root():
	return render_template('index.html',
		username = cas.username,
		display_name = cas.attributes)

if __name__ == "__main__":
	app.run(host='localhost',port=5000,debug=True,ssl_context = ('./ssl.crt', './ssl.key'))

#+END_SRC

* SSL Certifactes
  To our service more secure we use https and not http protocol.
  To get the certificates run =python cert.py= in the client server directory in the build

#+BEGIN_SRC python :eval no :tangle cert.py
from werkzeug.serving import make_ssl_devcert
make_ssl_devcert('./ssl', host='localhost')
#+END_SRC

* Frontend
  This code shows the simple front html of our client server which will be rendered by the server using jinja.
  When the user is logged out, it displays a login button
  When the user is logged in, it displays the credentials of the user
#+BEGIN_SRC python :tangle templates/index.html :eval no 

<!DOCTYPE html>
<html lang="en">
<head>
	<title>Login Page</title>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0"/>

	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.99.0/css/materialize.min.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.99.0/js/materialize.min.js"></script>

</head>

<body id="body">
<header>
</header>
	<main>
		<div class="container">
			<div class="row">
				<h3>Welcome to the VLEAD Service</h3>				
			</div>
			<div class="row">
			{% if username %}	
				<div class="col m4">
					<h5 class="card-title">Name: {{ username }} </h5>			
					<a class="btn" href="/cas/logout"> Logout </a>
				</div>
			{% else %}
				<div class="col m6 card">
					<a class="btn btn-danger" href="cas/login"> Login </a>	
				</div>
			{% endif %}
			</div>
		</div>
	</main>

<footer>		
</footer>
</body>
</html>


#+END_SRC
